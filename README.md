![Mascott](http://www.diariocultura.mx/wp-content/uploads/2012/11/cartero.jpg)

# Cartero

Cartero is an intelligent asset manager for web applications, especially suited for organizing, processing, and serving the many assets needed in "thick client" web applications built with JavaScript MVC frameworks.

## Benefits

* Instead of using separate directories for each type of asset, group your assets into "bundles" of related javascript files, stylesheets, and templates (e.g. keep person.coffee, person.scss, person.tmpl together in one directory).
* Specify the exact bundles that are required for each page in the page's template.
* Easily manage bundle dependencies.
* All assets that a page requires are automatically injected into the served HTML when the page's template is rendered. No more messing with `<script>` and `<link>` tags!
    * In development mode, served assets are preprocessed, but not minified or concatenated.
    * In production mode, served assets are preprocessed, minified and concatenated.
* All assets that live in the same directory as the page's template are automatically included when that page is rendered.
* Use your preferred JavaScript module system (e.g. RequireJS, AMD, CommonJS, Marionette Modules, etc.).
* Easily run custom preprocessing or minification tasks.
* Easily include Bower components as bundles.

## Overview

You keep all your assets in your application's **_asset bundle directory_** (except for assets that are just used by a particular page, which can be stored with that page's template - see below). Each subdirectory of that directory defines a **_bundle_** that may contain javascript files, stylesheets, and templates. (Additionally, each bundle may contain a `bundle.json` file, which contains meta-data about that bundle, such as any dependencies on other bundles.) By default, each bundle depends on the bundles defined by its parent directories. For example, in the following directory structure:

```
/assetBundles
    /jQuery
        jquery.js
        /backbone
            backbone.js
    /dialogs
        dialogManager.coffee
        /editPersonDialog
            editPersonDialog.coffee
            editPersonDialog.scss
            editPersonDialog.tmpl
```

The bundle named `jQuery/backbone` depends on the `jQuery` bundle, and the bundle named `dialogs/editPersonDialog` depends on the `dialogs` bundle. When you require a bundle, dependencies are automatically resolved.

Additionally, assets that live in the same directory as a page template will automatically be included when that template is rendered. For example, say your page templates live in a directory named `views`, as is typical for most web frameworks.

```
/views
    /login
        login.jade
        login.scss
        login.coffee
    /admin
        /peopleList
            peopleList.jade
            peopleList.scss
            peopleList.js
```

When the `login.jade` template is rendered, the `login.coffee` and `login.scss` assets will automatically be injected into the HTML of the page, as will the `peopleList.*` assets when the `peopleList.jade` template is rendered.

## How it works

The heart of Cartero is an intelligent [Grunt.js](http://gruntjs.com/) task that glues together other Grunt.js tasks, combining some brains with Grunt's brawn. You configure and call the **_Cartero Grunt Task_** from your application's gruntfile. You can specify exactly which preprocessing and minification tasks your application needs, and those tasks are then called by the Cartero task at the appropriate times. After the Cartero Grunt Task is finished, all of your assets will be preprocessed, and, in production mode, concatenated and minified. Additionally, the Cartero Grunt Task generates a `parcel.json` file that maps each of your page view templates to a list of all the assets that it uses. (A collection of assets that is served when a page is rendered is called a **_parcel_**.)

There is also a small but important piece of logic for serving up assets and injecting them into rendered HTML, called a **_Cartero Hook_**. This hook needs to reside in your web application framework, since it is used at the time your templates are rendered. Currently there is a Cartero Hook available only for Node.js / Express, but there is minimal logic involved and it is easy to implement in any environment. Each time you render a template, the Cartero Hook is used to looks up the template in the `parcel.json` file generated by the Cartero Grunt Task, and place HTML into three variables that are exposed to the template:

`cartero_js` - the raw HTML of the `<script>` elements that load all the required javascript files.

`cartero_css` - the raw HTML of the `<link>` elements that load all the required CSS files.

`cartero_tmpl` - the raw, concatenated contents of all the required client side template files.

You may then output the contents of those variables in the appropriate places in your template just like any other variable exposed to the template engine. For example, if you are using Jade templates, your page structure might look something like this:

```jade
// page layout
doctype 5
html(lang="en")
    head
        title myPage
        | !{cartero_js}
        | !{cartero_css} 
    body
        | !{cartero_tmpl} 
        h1 Hello World
```

## Getting started

```
npm install cartero
```

Now configure the Cartero Grunt Task in your applcation's gruntfile. (If you haven't used Grunt before, check out the [Getting Started](http://gruntjs.com/getting-started) guide.) Here is the minimal gruntfile configuration that is required to run the Cartero Grunt Task:

```
// example gruntfile

module.exports = function( grunt ) {
    grunt.initConfig( {
        cartero : {
            mode : "dev"
            bundleDir : {
                path : "bundles/"
            },
            viewDir : {
                path : "views/"
            }
            destDir : "static"
        }
    } );

    grunt.loadNpmTasks( "grunt-cartero" );
};
```

The three required options for the Cartero Grunt Task are `bundleDir`, `viewDir`, and `destDir`. The `bundleDir` option specifies where your asset bundles are located, and the `views` option specifies where you page views are located, that is, the directory that contains your page templates. The `destDir` option tells Cartero where to dump all of your processed and compiled assets. You generally want to dump your assets in your application's "public" folder, or the "static" folder in Node.js / Express apps. Cartero will automatically create two directories within `destDir` into which assets will be dumped - `bundle-assets` and `view-assets`. Those directories will contain assets specific to bundles and page views, respectively.

The Cartero Grunt Task also takes options that allow you to call any preprocessing and minification tasks you need to be performed on your assets (e.g. compiling .scss, uglifying javascript, etc.). See below for a complete list of options for the task.

Once you have configured the Cartero Grunt Task, you need to put a Cartero Hook in place in your web framework. As of this writing there is only a Cartero Hook available for Node.js / Express, which is implemented in the form of Express middleware. You just need to install the middleware, passing it a single argument, which is the directory into which all the assets were dumped, that is, the `destDir` option from the gruntfile configuration.

```javascript
// app.js

var app = express();
var carteroMiddleware = require( "cartero/middleware" ),
// ...

app.configure( function() {
    app.set( "port" , process.env.PORT || 3000 );
    app.set( "views" , path.join( __dirname, "views" ) );
    app.use( express.static( path.join( __dirname, "static" ) ) );

    // ...
    app.use( carteroMiddleware( path.join( __dirname, "static" ) ) );
} );
```

Now you are ready to go. To let Cartero know which asset bundles are required by which pages, you use **_Cartero Directives_**. The Cartero Grunt Task scans your page template files for these directives, which have the form `##cartero_xyz`. The "requires" directive is used to declare dependencies:

```jade
// peopleList.jade

// ##cartero_requires "jQuery", "dialogs/editPersonDialog"

doctype 5
html(lang="en")
    head
        title login
        | !{cartero_js}
        | !{cartero_css} 
    body
        | !{cartero_tmpl} 
        h1 People List
        // ...
```

Now when you run the following command from the directory of your gruntfile:

    grunt cartero

The Cartero Grunt Task will fire up, preprocess all of your assets, and generate the `parcels.json` file used by the Cartero Hook. In `dev` mode, the Cartero Grunt Task will automatically watch all of your assets for changes and recompile them as needed. In `prod` mode, the task will terminate after minifying and concatenating your assets. In either case, when you load a page, the three variables `cartero_js`, `cartero_css`, and `cartero_tmpl` with be available to your templates, and will contain all the raw HTML necessary to load the assets for the current page.